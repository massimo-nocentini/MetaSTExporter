
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sphinx’s side &#8212; MetaSTExporter  documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Exporting myself" href="self-doc.html" />
    <link rel="prev" title="Introduction" href="intro.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">MetaSTExporter</a></h1>



<p class="blurb">A lightweight tool for exporting Smalltalk stuff in a structured JSON.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=massimo-nocentini&repo=MetaSTExporter&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Sphinx’s side</a></li>
<li class="toctree-l1"><a class="reference internal" href="self-doc.html">Exporting myself</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="intro.html" title="previous chapter">Introduction</a></li>
      <li>Next: <a href="self-doc.html" title="next chapter">Exporting myself</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="intro.html" title="Previous document">Introduction</a>
        </li>
        <li>
          <a href="self-doc.html" title="Next document">Exporting myself</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <div class="section" id="sphinx-s-side">
<h1>Sphinx’s side<a class="headerlink" href="#sphinx-s-side" title="Permalink to this headline">¶</a></h1>
<p>Let’s start with importing the message</p>
<span class="target" id="pharo-compiledMethod-0"></span><div class="highlight-smalltalk notranslate" id="pharo-compiledmethod-continuation-class-currentdo"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&quot;Continuation class, protocol instance creation&quot;</span>
<span class="nf">currentDo:</span> <span class="nv">aBlock</span>

   <span class="o">^</span> <span class="nv">aBlock</span> <span class="nf">value:</span> (<span class="bp">self</span> <span class="nf">fromContext:</span> <span class="bp">thisContext</span> <span class="nf">sender</span>)
</pre></div>
</td></tr></table></div>
<p>that captures a continuation. In the above code block we see, in order of appearance:</p>
<ul class="simple">
<li><p>the class that hosts the behaviour, the class-side of <code class="docutils literal notranslate"><span class="pre">Continuation</span></code>,</p></li>
<li><p>the protocol that the bahaviour belongs to, <code class="docutils literal notranslate"><span class="pre">instance</span> <span class="pre">creation</span></code>,</p></li>
<li><p>the selector interleaved with argument names, <code class="docutils literal notranslate"><span class="pre">currentDo:</span> <span class="pre">aBlock</span></code>,</p></li>
<li><p>the body that express the computation, <code class="docutils literal notranslate"><span class="pre">^</span> <span class="pre">aBlock</span> <span class="pre">value:</span> <span class="pre">(self</span> <span class="pre">fromContext:</span> <span class="pre">thisContext</span> <span class="pre">sender)</span></code>.</p></li>
</ul>
<p>Such code block has been inserted with the Sphinx directive</p>
<dl class="rst directive">
<dt id="directive-pharo-autocompiledmethod">
<span id="directive-pharo:autocompiledmethod"></span><code class="sig-name descname">.. pharo:autocompiledmethod::</code><code class="sig-prename descclassname"> Continuation_class&gt;&gt;#currentDo:</code><a class="headerlink" href="#directive-pharo-autocompiledmethod" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>that also adds an entry to each of the following index labels,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">#currentDo:</span></code> is understood by,</p></li>
<li><p>a Continuation class understands,</p></li>
<li><p>Protocol instance creation.</p></li>
</ul>
<p>We can also import the previously seen <code class="docutils literal notranslate"><span class="pre">Continuation</span></code> class-side</p>
<span class="target" id="pharo-class-0"></span><div class="highlight-smalltalk notranslate" id="pharo-class-continuation-class"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nc">Continuation</span> <span class="nf">class</span>
	<span class="nf">instanceVariableNames:</span> <span class="s">&#39;&#39;</span>

<span class="c">&quot;I permit to save the execution flow and to restart it later. I was originally used in seaside.</span>

<span class="c">Example :</span>

<span class="c">You have an object with the instance variable executionFlow.</span>

<span class="c">You save the current execution flow with :</span>
<span class="c">Continuation currentDo: [ :cc | executionFlow := cc]</span>

<span class="c">You restart the execution flow with :</span>
<span class="c">executionFlow value: true</span>

<span class="c">&quot;</span>
</pre></div>
</td></tr></table></div>
<p>including the class comment; in parallel, the corresponding Sphinx code looks like this</p>
<dl class="rst directive">
<dt id="directive-pharo-autoclass">
<span id="directive-pharo:autoclass"></span><code class="sig-name descname">.. pharo:autoclass::</code><code class="sig-prename descclassname"> Continuation_class</code><a class="headerlink" href="#directive-pharo-autoclass" title="Permalink to this definition">¶</a></dt>
<dd><dl class="rst directive:option">
<dt id="directive-option-pharo-autoclass-include-comment">
<span id="directive:option-pharo:autoclass-include-comment"></span><code class="sig-name descname">:include-comment:</code><em class="property"> yes</em><a class="headerlink" href="#directive-option-pharo-autoclass-include-comment" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<p>In order to explain the body of <code class="docutils literal notranslate"><span class="pre">#currentDo:</span></code> we might also need</p>
<span class="target" id="pharo-compiledMethod-1"></span><div class="highlight-smalltalk notranslate" id="pharo-compiledmethod-blockclosure-value"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&quot;BlockClosure, protocol evaluating&quot;</span>
<span class="nf">value:</span> <span class="nv">anArg</span>

   <span class="c">&quot;Activate the receiver, creating a closure activation (MethodContext)</span>
<span class="c">    whose closure is the receiver and whose caller is the sender of this message.</span>
<span class="c">    Supply the argument and copied values to the activation as its arguments and copied temps.</span>
<span class="c">    Primitive. Optional (but you&#39;re going to want this for performance).&quot;</span>

   &lt;<span class="k">primitive:</span> 202&gt;
   <span class="nv">numArgs</span> <span class="nf">~=</span> <span class="m">1</span> <span class="nb">ifTrue:</span> [ <span class="bp">self</span> <span class="nf">numArgsError:</span> <span class="m">1</span> ]<span class="p">.</span>
   <span class="bp">self</span> <span class="nf">primitiveFailed</span>
</pre></div>
</td></tr></table></div>
<p>hosted in</p>
<span class="target" id="pharo-class-1"></span><div class="highlight-smalltalk notranslate" id="pharo-class-blockclosure"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nc">Object</span> <span class="nf">variableSubclass:</span> <span class="ss">#BlockClosure</span>
	<span class="nf">instanceVariableNames:</span> <span class="s">&#39;outerContext startpc numArgs&#39;</span>
	<span class="nf">classVariableNames:</span> <span class="s">&#39;&#39;</span>
	<span class="nf">package:</span> <span class="s">&#39;Kernel-Methods&#39;</span>

<span class="c">&quot;I contain a sequence of operations. I am defined by Smalltalk expressions inside square brackets. I permit to defer the enclosed operations until I execute a variant of #value. I can have my own arguments and temporaries as a regular method, but I am also able to use external variables: my enclosing method or block temporaries, arguments and receiver.</span>

<span class="c">examples :</span>
<span class="c">[ 1 + 2 ] value</span>
<span class="c">[ :arg | </span>
<span class="c">	| temp | </span>
<span class="c">	temp := arg. </span>
<span class="c">	temp ] value: 5</span>
<span class="c">[ ^ 5 ] value</span>

<span class="c">My return value corresponds to my final expression. A non local return (^) has the same effect as if I did not exist: it returns from my enclosing method, even if I&#39;m nested in other blocks. </span>

<span class="c">Implementation:</span>

<span class="c">Instance variables:</span>
<span class="c">	outerContext &lt;Context|nil&gt; context that defined me</span>
<span class="c">	startpc: &lt;SmallInteger&gt; (pc = program counter) offset of my first bytecode instruction in the compiledMethod bytecode  </span>
<span class="c">	numArgs: &lt;SmallInteger&gt; my number of arguments</span>

<span class="c">I am created at runtime through a special bytecode:</span>
<span class="c">closureNumCopied: x numArgs: y bytes z1 to z2</span>
<span class="c">On creation, the currently executed context is set to my outerContext, z1 is set as my startpc and y is set as my numArgs. After my creation, the current execution flow jumps to my last bytecode, z2, to skip the execution of my bytecode which is deferred until I execute a variant of #value.</span>

<span class="c">I am executed when I receive a variant of the message value. This message creates a new context, a block context &lt;MethodContext&gt;, which reference me in its variable closureOrNil. This new context executes my bytecode, which correspond to a subset of the bytecode of my enclosing method, starting at startpc and ending in blockReturn/return bytecode.</span>

<span class="c">Accessing variables of the my enclosing context is different depending on variables because of various optimizations:</span>
<span class="c">- self: I access the receiver of my enclosing method by accessing my context&#39;s receiver, which is always set to the enclosing method receiver.</span>
<span class="c">- copied variables: If I read a variable from an outerContext but I don&#39;t write into it and the variable is not modified after the BlockClosure creation, then the variable is copied in the blockClosure to be more efficient. </span>
<span class="c">- full variable: If I access and edit a variable from an outerContext, then the variable is stored in an external heap allocated array (named tempVector). The tempVector is known by the method and the block so they can both read and write these variables.</span>

<span class="c">Optimized block closures: </span>
<span class="c">Common blocks (2/3 of the blocks) are optimized directly in the compiler and have special behaviors. These blocks are the arguments/receiver of control structures: #ifNil:, #ifNotNil:, #ifTrue:, #ifFalse:, #whileTrue:, #whileFalse:, #to:do:, #to:by:do: .&quot;</span>
</pre></div>
</td></tr></table></div>
<p>both included in this documentation with</p>
<dl class="rst directive">
<dt id="directive-0">
<code class="sig-name descname">.. pharo:autocompiledmethod::</code><code class="sig-prename descclassname"> BlockClosure&gt;&gt;#value:</code><a class="headerlink" href="#directive-0" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>and</p>
<dl class="rst directive">
<dt id="directive-1">
<code class="sig-name descname">.. pharo:autoclass::</code><code class="sig-prename descclassname"> BlockClosure</code><a class="headerlink" href="#directive-1" title="Permalink to this definition">¶</a></dt>
<dd><dl class="rst directive:option">
<dt id="directive:option-pharo:autoclass-0">
<code class="sig-name descname">:include-comment:</code><em class="property"> yes</em><a class="headerlink" href="#directive:option-pharo:autoclass-0" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<p>respectively. Observe that it is straightforward to report another message for
the selector <code class="docutils literal notranslate"><span class="pre">#value:</span></code>,</p>
<span class="target" id="pharo-compiledMethod-2"></span><div class="highlight-smalltalk notranslate" id="pharo-compiledmethod-association-value"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&quot;Association, protocol accessing&quot;</span>
<span class="nf">value:</span> <span class="nv">anObject</span>

   <span class="c">&quot;Store the argument, anObject, as the value of the receiver.&quot;</span>

   <span class="nv">value</span> <span class="o">:=</span> <span class="nv">anObject</span>
</pre></div>
</td></tr></table></div>
<p>for instance, hosted in</p>
<span class="target" id="pharo-class-2"></span><div class="highlight-smalltalk notranslate" id="pharo-class-association"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nc">LookupKey</span> <span class="nf">subclass:</span> <span class="ss">#Association</span>
	<span class="nf">instanceVariableNames:</span> <span class="s">&#39;value&#39;</span>
	<span class="nf">classVariableNames:</span> <span class="s">&#39;&#39;</span>
	<span class="nf">package:</span> <span class="s">&#39;Collections-Support-Associations&#39;</span>
</pre></div>
</td></tr></table></div>
<p>quickly.</p>
</div>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="intro.html" title="Previous document">Introduction</a>
        </li>
        <li>
          <a href="self-doc.html" title="Next document">Exporting myself</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2021, Massimo Nocentini.
      
      |
      <a href="_sources/sphinx-side.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>